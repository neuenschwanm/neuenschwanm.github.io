<!DOCTYPE html>
<html>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src='https://unpkg.com/simple-statistics@7.7.5/dist/simple-statistics.min.js'></script>

<head>
</head>
<body>
	<table>
		<tr><td><label for="input">enter concentrations in uM</label></td></tr>
		<tr><td><textarea name="input" id="input" cols=50 rows=15></textarea></td></tr>

		<tr><td><label for="mylabel">label for plot</label></td></tr>
		<tr><td><input type="text" name="mylabel" id="mylabel"></input></td></tr>

		<tr><td><button type="button" id="calculateKm">Calculate Km</button></td></tr>
		<tr><td><div id="myPlot" style="width:100%;max-width:900px"></div><td></tr>
	</table>

	<script>

		var sArray = [];
		var vArray = [];
		var sbyvArray = [];
		
		function text_to_numeric_array (mytext) {
				
			 sArray = [];
			 vArray = [];
			 sbyvArray = [];
			
			const arrOfStr = mytext.split("\n");			
			
			for(let s of arrOfStr) {
									
				//test if it is not an empty string, this would be converted to 0
				if (s.length > 0) {
						
					//split line into x and y value
					const elements = s.split("\t");
						
					//test if the conversion of the string is NaN, if not, add to the numeric array				
					if (!Number.isNaN(Number(elements[0])) && !Number.isNaN(Number(elements[1]))) {
					
					//if the substrate concentration is not 0
						if (Number(elements[0]) > 0) {
							sArray.push(Number(elements[0]));
							vArray.push(Number(elements[1]));
							sbyvArray.push(Number(elements[0])/Number(elements[1]));
						}
					}
				}
			}
		}

		//creates a text from the array in memory to display the evaluated values
		function get_text_from_arrays() {
			var result = "";
			for (let i=0; i < sArray.length; i++) {
				result = result + sArray[i] + "\t" + vArray[i] + "\n";
			}
		
			return(result);
		}
		
		//function to calculate and plot Km using linearisation approach
		function calculate_Km() {		
			
			//read out data from textfield
			text_to_numeric_array(document.getElementById("input").value)

			//display what data got loaded
			document.getElementById("input").value = get_text_from_arrays();

			//prepare data for linear regression
			var linreg = []; //the linreg array is an array of pairs of variables
			
			for (let i=0; i < sArray.length; i++) {
				element = [sArray[i],sbyvArray[i]];
				linreg.push(element)
			}

			//create linear model in Hanes-Woolf plot
			lm2 = ss.linearRegression(linreg);

			//derive fitted parameters
			var m = lm2.m;
			var b = lm2.b;
			
			var Km = b/m;
			var Vmax = Km/b;
			
			//create result text
			var myresult = "Km: " + Km.toPrecision(3) + " uM";
			var mytitle = document.getElementById("mylabel").value;
			
			//create an array of 100 points with the predicted velocities for plotting
			var myy = [];
			var myx = [];
			
			var n = 100;
			for (let i=0; i < n; i++) {
				xelement = ss.min(sArray) + ((ss.max(sArray)-ss.min(sArray))/n)*i;
				yelement = (Vmax*xelement)/(Km+xelement);
				myx.push(xelement);
				myy.push(yelement);
			}

			//prepare data objects for plotting
			var trace1 = {
				  x: myx,
				  y: myy,
				  mode: 'lines',
				  type: 'scatter',
				  name: 'model',
				  marker: { size: 12 }
			};

			var trace2 = {
				  x: sArray,
				  y: vArray,
				  mode: 'markers',
				  type: 'scatter',
				  name: 'measured',
				  marker: { size: 6 }
			};

			var data = [ trace1, trace2 ];

			//define plot details
			var layout = {
				title: mytitle,
				
				annotations: [{
					text: myresult,
					font: {
					size: 13,
					color: 'rgb(116, 101, 130)',
				},
					showarrow: false,
					align: 'center',
					x: 0.5,
					y: 1,
					xref: 'paper',
					yref: 'paper',
				}],
				
				showlegend: false,
				xaxis: {
					title: {
						text: 'Substrate Concentration',
					}
				},
				
				yaxis: {
					title: {
						text: 'Velocity',
					}
				},
				
			};
			
			Plotly.newPlot('myPlot', data, layout);
		}

	
	</script>

<script>
//document initialization
		window.onload = function () {
			document.getElementById("calculateKm").onclick = calculate_Km;

}
</script>

</body>
</html>
